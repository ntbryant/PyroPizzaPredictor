---
title: "Pyro Pizza"
output: 
   html_notebook:
      code_folding: hide
      toc: true
      toc_float: true
      theme: simplex
---

<style type="text/css">

body, td {
   font-size: 14px;
}
code.r{
  font-size: 20px;
}
pre {
  font-size: 20px
}
</style>


```{r, warning=FALSE, message=FALSE, results='hide'}

library(googlesheets)
library(data.table)
library(dplyr)
library(plyr)
library(lubridate)
library(scales)
library(plotly)
library(ggplot2)
library(weatherData)
library(rwunderground)
library(jsonlite)
knitr::opts_chunk$set(fig.height=5, fig.width=7)

```

# Grabbing the Pyro Inventory Data

```{r}

##############################
# Pyro Pizza Data ############
##############################

# (my_sheets <- gs_ls())
# fin2016 = gs_title("2016 Springwater Ledger")
pyro = gs_key("1MzRbJdaHKv9CJMPeN7Z-WQtdoGuLWAyE9gvYS-_Mgc8")
# gs_ws_ls(fin2016)
inventory = pyro %>% gs_read_csv(ws = "12th INVENTORY", skip=0) %>% as.data.table

# fixing the dates in the 2016 data
setnames(inventory,colnames(inventory),c("date","day","initial_inventory","par","prep_rec","prep_actual","waste","final_inventory","short_long","scale","use_expected","use_actual","temp","precip","clouds","sun","wind","humidity","holiday","event"))
inventory = inventory[-1]
inventory[,c("event","temp","precip","clouds","sun","wind","humidity","holiday"):=NULL]
inventory[,date:=mdy(date)]

```

# Grabbing Daily Historical Weather Data

```{r}

####################################
# Historical Weather Data By Day ###
####################################

wu.apikey = readLines("config.io",warn=F)
rwunderground::set_api_key(wu.apikey)

getHistoricalWeather <- function(airport.code="PDX", date="20161219")
{
  base.url <- paste0('http://api.wunderground.com/api/',wu.apikey,'/')
  final.url <- paste0(base.url, 'history_', date, '/q/', airport.code, '.json')

  # reading in as raw lines from the web service
  conn <- url(final.url)
  raw.data <- readLines(conn, n=-1L, ok=TRUE)
 # Convert to a JSON
  weather.data <- fromJSON(paste(raw.data, collapse=""))
  close(conn)
  return(weather.data)
}

# get data for 10 days - restriction by Weather Underground for free usage
date.range <- seq.Date(from=as.Date('2016-12-19'), to=as.Date('2017-04-09'), by='1 day')

# Initialize a data frame
weather <- data.table()

# loop over dates, and fetch weather data
for(i in seq_along(date.range)) {
    weather.data <- getHistoricalWeather('PDX', format(date.range[i], "%Y%m%d"))
    weather.obs = setDT(weather.data$history$observations)
    weather.sum = setDT(weather.data$history$dailysummary)
    historic = data.table(Airport="PDX",
                Date=date.range[i],
                MaxTemp=weather.sum$maxtempi,
                MinTemp=weather.sum$mintempi,
                Conditions=weather.obs$conds,
                Rain=weather.sum$rain,
                Snow=weather.sum$snow,
                Humidity=weather.sum$humidity,
                Wind=weather.sum$meanwindspdi)
    weather <- rbind(weather, historic)
    print(i)
}

# save to CSV
write.csv(weather, file=('PDX-daily.csv'), row.names=FALSE)


```

# Grabbing the Monthly Historical Weather Data

```{r}

######################################
# Historical Weather Data By Month ###
######################################

getMonthlyWeather <- function(airport="PDX", date=as.Date("2016-12-19"))
{
  base.url <- paste0('http://api.wunderground.com/history/airport/K',airport,'/',
                     year(date),'/',
                     month(date),'/',
                     day(date),'/',
                     'MonthlyHistory.html?format=1&_ga=2.62584876.1655856170.1504224348-429437200.1504224348')

  # reading in as raw lines from the web service
  conn <- url(base.url)
  weather.data <- read.csv(conn)
  # close(conn)
  return(weather.data)
}

# get data for 10 days - restriction by Weather Underground for free usage
date.range <- seq.Date(from=as.Date('2016-12-19'), to=as.Date('2017-04-20'), by='1 month')

# Initialize a data frame
weather <- data.table()

i=1

# loop over months, and fetch weather data
for(i in seq_along(date.range)) {
    weather.data <- getMonthlyWeather('PDX', as.Date(date.range[i]))
    monthly = data.table(airport=rep("PDX",nrow(weather.data)),
                date=weather.data[,1],
                maxTemp=weather.data$Max.TemperatureF,
                minTemp=weather.data$Min.TemperatureF,
                precipitation=weather.data$PrecipitationIn,
                cloudCover=weather.data$CloudCover,
                conditions=weather.data$Events,
                humidity=weather.data$Mean.Humidity,
                wind=weather.data$Max.Wind.SpeedMPH)
    weather <- rbind(weather, monthly)
    print(i)
}

weather[,date:=as.Date(date)]

# filling in blank conditions based on cloudcover
weather[conditions=="",conditions:=ifelse(cloudCover>8,"Overcast","")]
weather[conditions=="",conditions:=ifelse(cloudCover<=8 & cloudCover>6,"Mostly Cloudly","")]
weather[conditions=="",conditions:=ifelse(cloudCover<=6 & cloudCover>4,"Partly Cloudly","")]
weather[conditions=="",conditions:=ifelse(cloudCover<=4 & cloudCover>2,"Scattered Clouds","")]
weather[conditions=="",conditions:=ifelse(cloudCover<=2,"Clear","Unknown")]

# correcting for trace precipitation
weather$precipitation = as.numeric(as.character(weather$precipitation))
weather[is.na(precipitation),precipitation:=0.001]
weather[,snow:=ifelse(grepl("Snow",conditions) & !grepl("Rain",conditions),precipitation,0)]
weather[,rain:=ifelse(grepl("Rain",conditions),precipitation,0)]

# save to CSV
write.csv(weather, file=('PDX-monthly.csv'), row.names=FALSE)

```

# Grabbing the 10-day Forecast Data

```{r}

#############################
# Forecast Weather Data #####
#############################

wu.apikey = readLines("config.io",warn=F)
rwunderground::set_api_key(wu.apikey)

getForecastWeather <- function(airport.code="PDX")
{
  base.url <- paste0('http://api.wunderground.com/api/',wu.apikey,'/')
  final.url <- paste0(base.url, 'forecast10day/q/', airport.code, '.json')

  # reading in as raw lines from the web service
  conn <- url(final.url)
  raw.data <- readLines(conn, n=-1L, ok=TRUE)
 # Convert to a JSON
  weather.data <- fromJSON(paste(raw.data, collapse=""))
  close(conn)
  return(weather.data)
}

weather.data <- getForecastWeather('PDX')
weather.data = setDT(weather.data$forecast$simpleforecast$forecastday)
forecast = data.table(Airport=rep("PDX",10),
                date=seq(Sys.Date(),Sys.Date()+9,by='day'),
                maxTemp=weather.data$high[[1]],
                minTemp=weather.data$low[[1]],
                conditions=weather.data$conditions,
                rain=weather.data$qpf_allday[[1]],
                snow=weather.data$snow_allday[[1]],
                humidity=weather.data$avehumidity,
                wind=weather.data$avewind[[1]])

```

# Combining Datasets

```{r}

# feature extraction
# prediction
# shiny interface
# add holiday dummy variable

dt = merge(inventory,weather,by="date")



```


